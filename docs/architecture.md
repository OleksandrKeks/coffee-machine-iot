# Архитектура системы — Saeco Lirika OTC RI9851/01

## Подход: Параллельное дублирование кнопок

В отличие от прямого управления помпой/нагревателем, мы подключаемся
ТОЛЬКО к линиям кнопок. ESP32 через оптопары замыкает те же контакты,
что и физические кнопки. Вся логика приготовления остаётся на штатной
плате Saeco.

## Кнопки Saeco Lirika OTC (7 штук)

### Кнопки напитков (4 шт.) — основные для дублирования:
- Эспрессо (кнопка 16 в мануале) — 1 нажатие = 1 порция, 2 = двойная
- Лунго (кнопка 17) — аналогично
- Капучино (кнопка 23) — One Touch, автоматический капучинатор
- Латте Макиато (кнопка 24) — One Touch

### Вспомогательные кнопки (3 шт.):
- Крепость (кнопка 19) — цикл из 3 степеней
- Меню (кнопка 22) — горячая вода, пенка, настройки, очистка
- Вкл/Выкл (кнопка 18/21) — включение машины

## Способ подключения: Оптопары

```
ESP32 GPIO --> Резистор 330Ω --> LED оптопары PC817
                                        |
Контакт кнопки A ---[Фототранзистор]--- Контакт кнопки B
```

Когда ESP32 подаёт HIGH на GPIO → LED в оптопаре светит →
фототранзистор открывается → контакты кнопки замкнуты →
Saeco "видит" нажатие кнопки.

### Почему оптопары, а не реле:
- Гальваническая развязка ESP32 от платы Saeco
- Бесшумная работа (реле щёлкает)
- Быстрое переключение (можно имитировать короткое/длинное нажатие)
- Компактный размер
- Низкое энергопотребление

## API эндпоинты (план)

### Управление напитками
- `POST /espresso` — приготовить эспрессо (params: double=false)
- `POST /lungo` — приготовить лунго (params: double=false)
- `POST /cappuccino` — приготовить капучино
- `POST /latte` — приготовить латте макиато
- `POST /stop` — остановить текущую подачу (повторное нажатие той же кнопки)

### Настройки
- `POST /strength` — переключить крепость
- `POST /power` — вкл/выкл машины

### Статус
- `GET /status` — текущее состояние (включена/выключена, готовит, ошибка)

## Имитация нажатий
- Короткое нажатие: HIGH 200мс → LOW
- Двойное нажатие (2 порции): HIGH 200мс → LOW 300мс → HIGH 200мс → LOW
- Длинное нажатие (программирование): HIGH 3000мс → LOW

## Что НЕ дублируем через ESP32
- Регулировку помола (механическая, ручка внутри)
- Открытие/закрытие сервисной дверцы
- Заливку воды / засыпку зёрен
- Установку/снятие варочного блока

## Опциональные улучшения (фаза 2)
- Чтение дисплея Saeco для отображения статуса на телефоне
- Датчик уровня воды (внешний) для уведомлений
- Расписание: автовключение + приготовление по таймеру
- Интеграция с Home Assistant / Google Home / Alexa
